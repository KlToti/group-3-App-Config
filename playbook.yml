- name : Elasticsearch app configuration 
  hosts : ElasticSearch_server
  remote_user: root
  vars:
    ansible_connection: aws_ssm
    ansible_aws_ssm_bucket_name: elk-private
    ansible_aws_ssm_region: eu-central-1

  tasks:
    - name: Install Prerequisites 
      apt: name= state=latest update_cache=yes
      with_items:
        - apt-transport-https
        - openssl
        - default-jdk

    - name: Update the /etc/inventory.hosts file with node name
      become: yes
      lineinfile:
        dest: "/etc/inventory.hosts"
        regexp: '.*{{ item }}$'
        line: "{{ hostvars[item].ansible_host }} {{item}}"
        state: present
      when: hostvars[item].ansible_host is defined
      with_items: "{{groups['es-cluster']}}"

    #install ElasticSearch
    - name: Import the Elastic Key
      apt_key:
        url: https://artifacts.elastic.co/GPG-KEY-elasticsearch
        state: present
    - name: Adding Elastic APT repository
      apt_repository:
        repo: deb https://artifacts.elastic.co/packages/8.x/apt stable main
        state: present
        filename: elastic-7.x.list
        update_cache: yes
    - name: install elasticsearch
      apt:
        name: elasticsearch
        state: present
        update_cache: yes
    - name: reload systemd config
      systemd: daemon_reload=yes
    - name: enable service elasticsearch and ensure it is not masked
      systemd:
        name: elasticsearch
        enabled: yes
        masked: no
    - name: ensure elasticsearch is running
      systemd: state=started name=elasticsearch

    #configure file
    - name: Configure elasticsearch.yml File
      copy:
        src: '{{item.src}}'
        dest: /etc/elasticsearch/elasticsearch.yml
        owner: root
        group: elasticsearch
      with_items:                                                                                                                                                 
        - { src: '/etc/elasticsearch.yml'}
    
    #Change the ownership
    #- name: set elasticsearch permissions
    #  file:
    #    path: /usr/share/elasticsearch
    #    state: directory
    #    recurse: yes
    #   owner: elasticsearch
    #    group: elasticsearch

    #

    #ElasticSearch start
    - name: restart elasticsearch after change configuration by configure-elastic-file role
      systemd:
        state: restarted
        daemon_reload: yes
        name: elasticsearch
    - name: ensure elasticsearch is running
      systemd:
        state=started
        name=elasticsearch
